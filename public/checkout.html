<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout | SUIT YOURSELF</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="checkout-page">
  <!-- Header -->
  <header class="header header-light header-minimal">
    <nav class="nav">
      <a href="/" class="logo">SUIT YOURSELF</a>
      <span class="checkout-title">Checkout</span>
      <a href="/products.html" class="continue-shopping">Continue Shopping</a>
    </nav>
  </header>

  <!-- Checkout Content -->
  <main class="checkout-container">
    <!-- Order Summary -->
    <aside class="checkout-summary">
      <h2>Order Summary</h2>
      <div class="summary-items" id="summary-items">
        <!-- Populated by JS -->
      </div>
      <div class="summary-totals">
        <div class="summary-row">
          <span>Subtotal</span>
          <span id="summary-subtotal">$0.00</span>
        </div>
        <div class="summary-row">
          <span>Shipping</span>
          <span>Free</span>
        </div>
        <div class="summary-row">
          <span>Service Fee</span>
          <span id="summary-fee">$0.00</span>
        </div>
        <div class="summary-row summary-total">
          <span>Total</span>
          <span id="summary-total">$0.00</span>
        </div>
      </div>
    </aside>

    <!-- Payment Section -->
    <section class="checkout-payment">
      <div class="checkout-steps">
        <!-- Customer Info -->
        <div class="checkout-step" id="step-customer">
          <h2>1. Contact Information</h2>
          <div class="form-group">
            <input type="email" id="customer-email" placeholder="Email address" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <input type="text" id="customer-first" placeholder="First name" required>
            </div>
            <div class="form-group">
              <input type="text" id="customer-last" placeholder="Last name" required>
            </div>
          </div>
        </div>

        <!-- Express Checkout -->
        <div class="checkout-step" id="step-payment">
          <h2>2. Payment</h2>
          <p class="payment-subtitle">Select a payment method to complete your order</p>
          
          <div id="express-checkout-container" class="express-checkout-wrapper">
            <div class="loading-placeholder">
              <div class="spinner"></div>
              <span>Loading payment options...</span>
            </div>
          </div>
          
          <div class="payment-status" id="payment-status"></div>
          
          <div class="secure-badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0110 0v4"></path>
            </svg>
            <span>Secure checkout - Your payment is protected</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer footer-minimal">
    <p>&copy; 2025 Suit Yourself. Secure checkout powered by Payabli.</p>
  </footer>

  <script src="/js/store.js"></script>
  <script>
    let orderId = null;
    let verificationData = null;
    let payabliComponent = null;
    
    // =================================================================
    // INITIALIZATION
    // =================================================================
    
    async function initCheckout() {
      const cart = await Store.getCart();
      
      if (!cart || cart.items.length === 0) {
        window.location.href = '/products.html';
        return;
      }
      
      renderSummary(cart);
    }
    
    function renderSummary(cart) {
      const itemsEl = document.getElementById('summary-items');
      const serviceFee = Math.round(cart.subtotal * 0.03 * 100) / 100;
      const total = cart.subtotal + serviceFee;
      
      itemsEl.innerHTML = cart.items.map(item => `
        <div class="summary-item">
          <img src="${item.image}" alt="${item.name}">
          <div class="item-details">
            <h4>${item.name}</h4>
            <p>Size: ${item.size} | Qty: ${item.quantity}</p>
          </div>
          <span class="item-price">$${(item.price * item.quantity).toFixed(2)}</span>
        </div>
      `).join('');
      
      document.getElementById('summary-subtotal').textContent = `$${cart.subtotal.toFixed(2)}`;
      document.getElementById('summary-fee').textContent = `$${serviceFee.toFixed(2)}`;
      document.getElementById('summary-total').textContent = `$${total.toFixed(2)}`;
    }
    
    // =================================================================
    // ORDER CREATION & PAYMENT
    // =================================================================
    
    async function createOrderAndLoadPayment() {
      const email = document.getElementById('customer-email').value;
      const firstName = document.getElementById('customer-first').value;
      const lastName = document.getElementById('customer-last').value;
      
      if (!email || !firstName || !lastName) {
        showStatus('error', 'Please fill in all contact fields');
        return;
      }
      
      showStatus('loading', 'Preparing checkout...');
      
      try {
        // Create order
        const cartId = Store.getCartId();
        const orderResponse = await fetch('/api/orders/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cartId,
            customer: { email, firstName, lastName }
          })
        });
        
        if (!orderResponse.ok) throw new Error('Failed to create order');
        const orderData = await orderResponse.json();
        orderId = orderData.orderId;
        
        // Get secure checkout config
        const configResponse = await fetch(`/api/checkout/config/${orderId}`);
        if (!configResponse.ok) throw new Error('Failed to load payment');
        const config = await configResponse.json();
        
        // Store verification data
        verificationData = config.verification;
        
        // Update summary with server amounts
        document.getElementById('summary-subtotal').textContent = `$${config.order.subtotal.toFixed(2)}`;
        document.getElementById('summary-fee').textContent = `$${config.order.serviceFee.toFixed(2)}`;
        document.getElementById('summary-total').textContent = `$${config.order.total.toFixed(2)}`;
        
        // Load Payabli script and initialize
        await loadPayabliScript(config.componentUrl);
        initializeExpressCheckout(config.payabliConfig);
        
      } catch (error) {
        console.error('Checkout error:', error);
        showStatus('error', 'Failed to load checkout. Please try again.');
      }
    }
    
    function loadPayabliScript(url) {
      return new Promise((resolve, reject) => {
        if (window.PayabliComponent) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = () => reject(new Error('Failed to load payment component'));
        document.head.appendChild(script);
      });
    }
    
    function initializeExpressCheckout(config) {
      const container = document.getElementById('express-checkout-container');
      container.innerHTML = '<div id="express-checkout-container"></div>';
      
      const fullConfig = {
        ...config,
        rootContainer: 'express-checkout-container',
        
        functionCallBackReady: (data) => {
          console.log('ExpressCheckout ready:', data);
          hideStatus();
          
          if (!data.applePay && !data.googlePay) {
            showStatus('warning', 'No digital wallets available on this device. Please try on a device with Apple Pay or Google Pay configured.');
          }
        },
        
        functionCallBackSuccess: async (data) => {
          console.log('Payment success:', data);
          showStatus('loading', 'Confirming your order...');
          
          try {
            const confirmResponse = await fetch('/api/checkout/confirm', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                orderId,
                referenceId: data.data.responseData.referenceId,
                paymentMethod: data.paymentMethod,
                verification: verificationData
              })
            });
            
            const result = await confirmResponse.json();
            
            if (confirmResponse.ok && result.success) {
              // Clear cart and redirect to success
              Store.clearCart();
              window.location.href = `/success.html?orderId=${orderId}`;
            } else {
              showStatus('error', result.error || 'Payment could not be confirmed');
            }
            
          } catch (error) {
            console.error('Confirmation error:', error);
            showStatus('error', 'Payment confirmation failed. Please contact support.');
          }
        },
        
        functionCallBackError: (data) => {
          console.error('Payment error:', data);
          showStatus('error', 'Payment failed. Please try again.');
        },
        
        functionCallBackCancel: () => {
          showStatus('info', 'Payment cancelled. You can try again when ready.');
          setTimeout(hideStatus, 3000);
        }
      };
      
      payabliComponent = new PayabliComponent(fullConfig);
    }
    
    // =================================================================
    // UI HELPERS
    // =================================================================
    
    function showStatus(type, message) {
      const statusEl = document.getElementById('payment-status');
      statusEl.className = `payment-status ${type}`;
      
      if (type === 'loading') {
        statusEl.innerHTML = `<div class="spinner"></div><span>${message}</span>`;
      } else {
        statusEl.innerHTML = `<span>${message}</span>`;
      }
      statusEl.style.display = 'flex';
    }
    
    function hideStatus() {
      document.getElementById('payment-status').style.display = 'none';
    }
    
    // =================================================================
    // EVENT LISTENERS
    // =================================================================
    
    // Auto-trigger payment load when customer info is filled
    let paymentLoaded = false;
    
    function checkAndLoadPayment() {
      if (paymentLoaded) return;
      
      const email = document.getElementById('customer-email').value;
      const firstName = document.getElementById('customer-first').value;
      const lastName = document.getElementById('customer-last').value;
      
      if (email && firstName && lastName) {
        paymentLoaded = true;
        createOrderAndLoadPayment();
      }
    }
    
    document.getElementById('customer-email').addEventListener('blur', checkAndLoadPayment);
    document.getElementById('customer-first').addEventListener('blur', checkAndLoadPayment);
    document.getElementById('customer-last').addEventListener('blur', checkAndLoadPayment);
    
    // Initialize
    Store.init();
    initCheckout();
  </script>
</body>
</html>
